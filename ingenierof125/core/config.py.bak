from __future__ import annotations

import os
from dataclasses import dataclass, replace


def _env(name: str, default: str) -> str:
    v = os.getenv(name)
    return default if v is None or v.strip() == "" else v.strip()


def _env_int(name: str, default: int) -> int:
    v = os.getenv(name)
    if v is None or v.strip() == "":
        return default
    try:
        return int(v.strip())
    except ValueError:
        return default


def _env_float(name: str, default: float) -> float:
    v = os.getenv(name)
    if v is None or v.strip() == "":
        return default
    try:
        return float(v.strip())
    except ValueError:
        return default


@dataclass(frozen=True, slots=True)
class AppConfig:
    udp_host: str = "0.0.0.0"
    udp_port: int = 20777

    # F1 25 expected header fields
    packet_format: int = 2025
    game_year: int = 25

    queue_maxsize: int = 2048
    stats_interval_s: float = 2.0

    log_level: str = "INFO"
    log_dir: str = "logs"
    log_file: str = "ingenierof125.log"

    @staticmethod
    def from_env() -> "AppConfig":
        return AppConfig(
            udp_host=_env("ING_UDP_HOST", "0.0.0.0"),
            udp_port=_env_int("ING_UDP_PORT", 20777),
            packet_format=_env_int("ING_PACKET_FORMAT", 2025),
            game_year=_env_int("ING_GAME_YEAR", 25),
            queue_maxsize=_env_int("ING_QUEUE_MAXSIZE", 2048),
            stats_interval_s=_env_float("ING_STATS_INTERVAL_S", 2.0),
            log_level=_env("ING_LOG_LEVEL", "INFO").upper(),
            log_dir=_env("ING_LOG_DIR", "logs"),
            log_file=_env("ING_LOG_FILE", "ingenierof125.log"),
        )

    def override(
        self,
        udp_host: str | None = None,
        udp_port: int | None = None,
        packet_format: int | None = None,
        game_year: int | None = None,
        queue_maxsize: int | None = None,
        stats_interval_s: float | None = None,
        log_level: str | None = None,
    ) -> "AppConfig":
        return replace(
            self,
            udp_host=self.udp_host if udp_host is None else udp_host,
            udp_port=self.udp_port if udp_port is None else udp_port,
            packet_format=self.packet_format if packet_format is None else packet_format,
            game_year=self.game_year if game_year is None else game_year,
            queue_maxsize=self.queue_maxsize if queue_maxsize is None else queue_maxsize,
            stats_interval_s=self.stats_interval_s if stats_interval_s is None else float(stats_interval_s),
            log_level=self.log_level if log_level is None else log_level,
        )
