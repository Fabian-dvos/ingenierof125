from __future__ import annotations

import asyncio
import logging

from ingenierof125.core.config import AppConfig
from ingenierof125.core.logging_setup import setup_logging
from ingenierof125.core.stats import RuntimeStats, StatsReporter
from ingenierof125.telemetry.dispatcher import PacketDispatcher
from ingenierof125.telemetry.udp_listener import UdpListener


async def run_app(cfg: AppConfig) -> None:
    setup_logging(cfg)
    log = logging.getLogger("ingenierof125")
    log.info(
        "Starting udp=%s:%s format=%s year=%s",
        cfg.udp_host, cfg.udp_port, cfg.packet_format, cfg.game_year
    )

    queue: asyncio.Queue[bytes] = asyncio.Queue(maxsize=cfg.queue_maxsize)
    stats = RuntimeStats()

    listener = UdpListener(cfg.udp_host, cfg.udp_port, queue, drop_when_full=True, stats=stats)
    dispatcher = PacketDispatcher(expected_packet_format=cfg.packet_format, expected_game_year=cfg.game_year, stats=stats)
    reporter = StatsReporter(stats=stats, queue=queue, interval_s=cfg.stats_interval_s)

    t1 = asyncio.create_task(listener.run(), name="udp-listener")
    t2 = asyncio.create_task(dispatcher.run(queue), name="packet-dispatcher")
    t3 = asyncio.create_task(reporter.run(), name="stats-reporter")

    try:
        await asyncio.gather(t1, t2, t3)
    finally:
        log.info("Shutting down...")
        reporter.stop()
        dispatcher.stop()
        listener.stop()
        for t in (t1, t2, t3):
            t.cancel()
        await asyncio.gather(t1, t2, t3, return_exceptions=True)
